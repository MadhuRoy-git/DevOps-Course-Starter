services:
    - docker
before_script:
    - echo "$DOCKER_PASSWORD" | docker login --username $DOCKER_USER --password-stdin
script:
    - docker build --target test --tag my-test-image .
    - docker run my-test-image tests/unit
    - docker run my-test-image tests/integration
    - docker run --env FLASK_ENV --env BOARD_ID --env MONGO_CONNECTION_URL my-test-image tests/endtoend
    - docker build --target production --tag $DOCKER_USER/todo-app:latest .  
    - docker push $DOCKER_USER/todo-app:latest
deploy:   
    provider: script
    script: 
        - curl -dH -X POST "$AZURE_WEBHOOK_URL"
    on:  
        branch: master
